# Changelog

このプロジェクトのすべての重要な変更は、このファイルに記録されます。

形式は[Keep a Changelog](https://keepachangelog.com/ja/1.0.0/)に基づいており、
このプロジェクトは[セマンティック バージョニング](https://semver.org/lang/ja/)に準拠しています。

## Python開発者向け注意
各エントリには詳細な説明と、TypeScript特有の実装について補足説明を含めています。

---

## [1.0.1] - 2025-12-28

### Fixed

#### Pydantic v2移行に伴うFoundryConfig環境変数バインディング修正

**概要**: Pydantic v2移行後、FoundryConfigの環境変数バインディング不具合を修正

**詳細**:
- Pydantic v2では`env_prefix`やConfigクラスによる自動マッピングが効かなくなり、`FOUNDRY_`環境変数が`foundry_endpoint`等のフィールドにバインドされなくなった
- そのため、テスト・本番ともに`FoundryConfig`の必須フィールドが未設定となり、バリデーションエラーで全テストが落ちる状態となった
- 試行錯誤の過程で、`model_config`の`env_prefix`や`_env_file=None`指定、pytest-dotenvやconftest.pyでの環境変数制御などを検証したが、根本解決には至らなかった
- 最終的に、各フィールドに`Field(..., alias="FOUNDRY_...")`を明示的に指定することで、Pydantic v2でも正しく環境変数がバインドされるようになり、全テストが本来のバリデーション要件のまま合格するようになった

**技術的決定**:
- `foundry_endpoint: str = Field(..., alias="FOUNDRY_ENDPOINT")`のように、全フィールドでaliasを明示
- `model_config`の`env_prefix`は削除し、`env_file=None`のみ残した
- テスト用の環境変数セットはconftest.pyのfixtureで一元管理

**Python開発者向け補足**:
- v1→v2でのBaseSettingsの環境変数バインディング仕様変更に注意
- v2では`Field(..., alias=...)`で明示しないと環境変数がバインドされない

**影響範囲**:
- `src/common/mcp/foundry_tool_registry.py`のFoundryConfig定義
- すべてのテスト（バリデーション要件は維持）

**次のステップ**:
- この修正は`fix/pydantic-v2-env-alias`ブランチで管理し、mainへのマージは十分なレビュー後に行う

## [Unreleased]

### Added (追加)

#### プロジェクト初期化 - 2025-12-28

**概要**: Stock MAGI Systemプロジェクトの基本構造を確立

**追加されたファイル**:
- `.kiro/steering/product.md`: プロダクトビジョン、MVP戦略、開発方針
- `.kiro/steering/tech.md`: 技術スタック、アーキテクチャパターン、TypeScript規約
- `.kiro/steering/structure.md`: ディレクトリ構成、命名規則、Git管理方針
- `README.md`: プロジェクト概要とセットアップ手順
- `CHANGELOG.md`: 変更履歴（このファイル）

## [1.0.2] - 2025-12-28

### Changed

- **Repository hygiene**: Updated `.gitignore` to properly ignore Python artifacts including `__pycache__/`, `*.pyc`, virtualenv directories (`.venv/`, `venv/`), `.pytest_cache/`, and coverage files. This reduces noise from generated files in `git status`.

### Added

- **Test fixture**: `tests/conftest.py` adds an autouse, function-scoped fixture `filter_and_set_foundry_env_vars` to ensure `FOUNDRY_` environment variables are set consistently during tests.
- **Lockfile**: `poetry.lock` (generated by Poetry) was added to ensure reproducible dependency resolution across environments.
- **Testing docs**: `docs/TESTING.md` documents test execution commands and common troubleshooting notes (Pydantic v2 considerations).
- **Developer tasks**: `.kiro/specs/tasks.md` documents the Pydantic v2 migration tasks and next steps.
- **Repository guidance**: `copilot-instructions.md` documents versioning and changelog policies for contributors.

### Notes

- These changes are primarily repository maintenance and test-enablement related; they do not alter runtime behavior of production code beyond the Pydantic v2 fix recorded in 1.0.1.


**技術的決定**:

1. **言語選択: TypeScript**
   - 理由: Copilot+ PC (ARM64)でのPythonライブラリ互換性問題を回避
   - Pythonとの違い: 静的型付け、コンパイル必要、`any`型使用禁止
   - Python開発者への配慮: 詳細なコメント、TypeScriptガイド作成予定

2. **クラウドプラットフォーム: Azure**
   - 理由: Microsoft Foundry統合、Azure OpenAI利用
   - 主要サービス:
     - Azure Functions: サーバーレス実行（Pythonの`azure.functions`に相当）
     - Azure OpenAI: LLM推論（Pythonの`openai`パッケージに相当）
     - Azure Storage: データ永続化（Pythonの`azure-storage-blob`に相当）

3. **アーキテクチャパターン: ヘキサゴナル（Ports & Adapters）**
   - コアドメイン: ビジネスロジック（エージェント、合議）
   - ポート: インターフェース定義（Pythonの`Protocol`や抽象基底クラスに相当）
   - アダプター: 外部システム統合（Pythonのアダプターパターンと同様）
   - メリット: テスト容易性、拡張性、依存関係の明確化

4. **プラグインアーキテクチャ**
   - エージェントレジストリ: 動的登録（Pythonの`importlib`に似た概念）
   - MCPコネクタ: プラグイン方式（Pythonのパッケージエントリーポイントに相当）

5. **テスト戦略: TDD + 80%カバレッジ**
   - フレームワーク: Vitest（Pythonの`pytest`に相当）
   - カバレッジ: c8（Pythonの`coverage.py`に相当）
   - モック: MSW（Pythonの`unittest.mock`や`responses`に相当）

**Git管理**:
- 新しいリポジトリを初期化
- ブランチ戦略: Git Flow（main, develop, feature/*, hotfix/*）
- コミット規約: Conventional Commits

**次のステップ**:
1. 基本的なTypeScriptプロジェクトセットアップ（`package.json`, `tsconfig.json`）
2. ディレクトリ構造作成（`src/core/`, `src/adapters/`, etc.）
3. 型定義ファイル作成（`src/core/models/`）
4. エージェント基底インターフェース実装
5. 最初のユニットテスト作成

**Python開発者向け補足**:
- TypeScriptは型定義が必須です。すべての変数、関数の引数、戻り値に型を指定します
- `any`型は使用禁止（Pythonの動的型付けに相当しますが、型安全性を損なうため）
- インターフェース（`interface`）はPythonの`Protocol`や抽象基底クラスに似ています
- ヘキサゴナルアーキテクチャは、Pythonでもよく使われるクリーンアーキテクチャの一種です

**影響範囲**:
- 新規プロジェクトのため、既存コードへの影響なし
- 今後のすべての開発は、このSteering定義に従う

**参考リンク**:
- [TypeScript公式ドキュメント](https://www.typescriptlang.org/docs/)
- [ヘキサゴナルアーキテクチャ](https://alistair.cockburn.us/hexagonal-architecture/)
- [Conventional Commits](https://www.conventionalcommits.org/ja/v1.0.0/)

---

## 変更履歴の記録方法

### カテゴリ
- **Added (追加)**: 新機能
- **Changed (変更)**: 既存機能の変更
- **Deprecated (非推奨)**: 将来削除予定の機能
- **Removed (削除)**: 削除された機能
- **Fixed (修正)**: バグ修正
- **Security (セキュリティ)**: 脆弱性対応

### エントリ形式

各変更には以下を含める:
1. **概要**: 何を変更したか（1-2行）
2. **詳細**: なぜ変更したか、どのように実装したか
3. **技術的決定**: TypeScript特有の実装方法
4. **Python開発者向け補足**: Pythonとの対応関係
5. **影響範囲**: どのコンポーネントが影響を受けるか
6. **次のステップ**: 次に何をすべきか（該当する場合）

### 例

```markdown
#### エージェントレジストリ実装 - 2025-12-28

**概要**: 動的なエージェント登録・管理機能を実装

**詳細**:
- `AgentRegistry`クラスを作成
- `register()`, `unregister()`, `getAll()`メソッド実装
- ジェネリック型を使用して型安全性を確保

**技術的決定**:
- TypeScriptのMap型を使用（Pythonの`dict`に相当）
- ジェネリック`<T extends Agent>`で型制約（Pythonの`TypeVar`に相当）

**Python開発者向け補足**:
```python
# Python equivalent
class AgentRegistry:
    def __init__(self):
        self._agents: Dict[str, Agent] = {}
    
    def register(self, name: str, agent: Agent) -> None:
        self._agents[name] = agent
```

TypeScriptでは以下のように実装:
```typescript
class AgentRegistry {
  private agents: Map<string, Agent> = new Map();
  
  register(name: string, agent: Agent): void {
    this.agents.set(name, agent);
  }
}
```

**影響範囲**:
- `src/core/agents/registry.ts`: 新規作成
- `tests/unit/agents/registry.test.ts`: ユニットテスト追加

**次のステップ**:
1. エージェント基底インターフェース定義
2. 短期トレーダーエージェント実装
```
