# テスト実行手順・運用ノート

このドキュメントは、Stock MAGI Systemプロジェクトのテスト実行方法・運用上の注意点をまとめたものです。

## テスト実行コマンド

- 標準実行:
  ```bash
  poetry run pytest
  ```
- 詳細表示・カバレッジ付き:
  ```bash
  poetry run pytest -v --cov=src --cov-report=html
  ```

## テスト環境のセットアップ

- **環境変数**: テスト用の`.env`ファイル（例: `.env.test`）を用意し、必要なAPIキーやエンドポイントを設定してください。
- **Poetry環境**: 依存パッケージは`poetry install`でインストール。
- **pytestのfixtureやmock**: モデルやAPIのモックが必要な場合は、`conftest.py`や各テストファイル内でfixtureを定義。

## 主な注意点

- **Pydantic v2対応**: バリデーションエラーのメッセージ仕様がv1と異なるため、`pytest.raises()`の`match`パターンはv2仕様に合わせてください。
- **環境変数未設定時の挙動**: FoundryConfig等で環境変数が未設定だとValidationErrorが発生します。テスト用の環境変数セットアップを必ず行ってください。
- **API/外部サービス依存テスト**: モックまたはテスト用エンドポイントを利用し、外部APIへの実リクエストは避けてください。
- **モデル名・フィールド名の変更**: モデルやフィールド名を変更した場合、テスト側のassertやfixtureも必ず同期してください。

## 失敗例・トラブルシュート

- Pydantic v2のバリデーションエラー（extra fields, required未設定等）
- テスト用の環境変数が未設定、またはfixture/mockが正しく機能していない
- テストの例外メッセージがPydantic v2標準と一致しない
- モデルや設定のリファクタ時にテスト側の修正漏れ

## 今後の運用方針

- テスト実行手順・環境セットアップ・失敗時の対処法は本ファイルに随時追記
- CI/CDでの自動テスト実行時も、同様の手順・環境変数セットアップを徹底

---

何か問題が発生した場合は、このファイルを参照し、必要に応じて内容をアップデートしてください。
